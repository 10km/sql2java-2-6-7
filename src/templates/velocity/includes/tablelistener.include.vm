##$Id: tablelistener.java.vm,v 1.3 2007/11/12 14:06:30 kameleono Exp $
#parse( "schema.include.vm" )
#parse( "header.include.vm" )
$codewriter.setCurrentJavaFilename($schemaPkg, "TableListener.java")
package $schemaPkg;

import java.util.Collections;
import java.util.LinkedHashSet;
import java.util.Set;

#if(!$isGeneral)
import ${schemaPkg}.exception.DaoException;
#set ( $throwsString = "throws DaoException" )
#else
import ${schemaPkg}.exception.RuntimeDaoException;
#set ( $throwsString = "throws RuntimeDaoException" )
#end

/**
 * Listener that is notified of table changes.
 * @author guyadong
 */
public interface TableListener<B>{
    /**
     * This adapter class provides default implementations for the
     * methods declared by the {@link TableListener} interface.<br>
     * 
     * @author guyadong
     */
    public static class Adapter<B> implements TableListener<B>{

        @Override
        public void beforeInsert(B bean)$!throwsString {}

        @Override
        public void afterInsert(B bean)$!throwsString {}

        @Override
        public void beforeUpdate(B bean)$!throwsString {}

        @Override
        public void afterUpdate(B bean)$!throwsString {}

        @Override
        public void beforeDelete(B bean)$!throwsString {}

        @Override
        public void afterDelete(B bean)$!throwsString {}
        
        @Override
        public void done()$!throwsString {}
    }
    /**
     * Invoked just before inserting a B record into the database.
     *
     * @param bean the B that is about to be inserted
#if($throwsString)
     * @$!throwsString
#end  
     */
    public void beforeInsert(B bean)$!throwsString;


    /**
     * Invoked just after a B record is inserted in the database.
     *
     * @param bean the B that was just inserted
#if($throwsString)
     * @$!throwsString
#end  
     */
    public void afterInsert(B bean)$!throwsString;


    /**
     * Invoked just before updating a B record in the database.
     *
     * @param bean the B that is about to be updated
#if($throwsString)
     * @$!throwsString
#end  
     */
    public void beforeUpdate(B bean)$!throwsString;


    /**
     * Invoked just after updating a B record in the database.
     *
     * @param bean the B that was just updated
#if($throwsString)
     * @$!throwsString
#end  
     */
    public void afterUpdate(B bean)$!throwsString;


    /**
     * Invoked just before deleting a B record in the database.
     *
     * @param bean the B that is about to be deleted
#if($throwsString)
     * @$!throwsString
#end  
     */
    public void beforeDelete(B bean)$!throwsString;


    /**
     * Invoked just after deleting a B record in the database.
     *
     * @param bean the B that was just deleted
#if($throwsString)
     * @$!throwsString
#end  
     */
    public void afterDelete(B bean)$!throwsString;

    /**
     * Invoked in finally block, just after insert,update,delete.
     *
#if($throwsString)
     * @$!throwsString
#end  
     */
    public void done()$!throwsString;

    /**
     * listener event
     * {@code INSERT} insert a bean<br>
     * {@code UPDATE} update a bean<br>
     * {@code DELETE} delete a bean<br>
     * @author guyadong
     *
     */
    public static enum Event{
        /** insert a bean */
        INSERT,UPDATE,DELETE;
        /**
         * fire current event by  {@link ListenerContainer}
         * @param container
         * @param bean
#if($throwsString)
         * @$!throwsString
#end
         */
        public <B> void fire(ListenerContainer<B> container,B bean)$!throwsString {
            if(null == container || null == bean){
                return;
            }
            switch(this){
            case INSERT:
                container.afterInsert(bean);
                break;
            case UPDATE:
                container.afterUpdate(bean);
                break;
            case DELETE:
                container.afterDelete(bean);
                break;
            default:
                break;
            }
        }
        public <B extends BaseBean<B>> void fire(TableManager<B > manager,B bean)$!throwsString {
            if(null == manager || null == bean){
                return;
            }
            manager.fire(this, bean);
        }
    }
    /** 
     * container for multiple listener management
     * @author guyadong 
     */
    public static class ListenerContainer <B> implements TableListener<B> {
        private final Set<TableListener<B>> listeners = Collections.synchronizedSet(new LinkedHashSet<TableListener<B>>(16));
        public ListenerContainer() {
        }
    
        @Override
        public void beforeInsert(B bean)$!throwsString{
            for(TableListener<B> listener:listeners){
                listener.beforeInsert(bean);
            }
        }
    
        @Override
        public void afterInsert(B bean)$!throwsString{
            for(TableListener<B> listener:listeners){
                listener.afterInsert(bean);
            }
        }
    
        @Override
        public void beforeUpdate(B bean)$!throwsString{
            for(TableListener<B> listener:listeners){
                listener.beforeUpdate(bean);
            }
        }
    
        @Override
        public void afterUpdate(B bean)$!throwsString{
            for(TableListener<B> listener:listeners){
                listener.afterUpdate(bean);
            }
        }
    
        @Override
        public void beforeDelete(B bean)$!throwsString{
            for(TableListener<B> listener:listeners){
                listener.beforeDelete(bean);
            }
        }
    
        @Override
        public void afterDelete(B bean)$!throwsString{
            for(TableListener<B> listener:listeners){
                listener.afterDelete(bean);
            }
        }

        @Override
        public void done()$!throwsString{
            for(TableListener<B> listener:listeners){
                listener.done();
            }
        }
        /**
         * determine if the container is empty.
         * @return 
         */
        public boolean isEmpty() {
            return listeners.isEmpty();
        }
        /**
         * determine if the {@code listener} be added.
         * @param listener
         * @return {@code true} if {@code listener} exists in container
         */
        public boolean contains(TableListener<B> listener) {
            return listeners.contains(listener);
        }
        /**
         * add {@code listener} into container
         * @return {@code true} if add successfully.
         */
        public boolean add(TableListener<B> listener) {
            return null == listener ? false : listeners.add(listener);
        }
        /**
         * remove {@code listener} from container
         * @param listener instance that will be removed.
         * @return {@code true} if remove successfully.
         */
        public boolean remove(TableListener<B> listener) {
            return null == listener? false : listeners.remove(listener);
        }
        /** remove all listeners in container */
        public void clear() {
            listeners.clear();
        }
    }
}

